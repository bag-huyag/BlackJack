BlackJack

Правила игры 
В игре могут участвовать от 2 до 4 человек
Игрок создаёт стол, где устанавливает ставку
Каждый подключающийся к столу игрок делает установленную ставку
Ставки делаются при входе на стол единоразово, в ходе игры делать ставки невозможно
Изначально даëтся 2 карты. В процессе даëтся по 1 карте
Цель игры заключается в том, чтобы набрать 21 очка включительно
Если игрок набирает 21 очко, то он считается победителем игры, если набирает больше, то он считается проигравшим
Когда игроки заканчивают добирать карты, победителем считается тот, у кого больше очков на руках, но не больше, чем 21. Если победителей несколько, выигрыш делится поровну.
В случае победы игрок забирает все деньги
Если победителей несколько, то они делят между собой выигрыш

ER диаграмма
![ER диаграмма]([https://github.com/jon/coolproject/raw/master/image/image.png](https://github.com/bag-huyag/BlackJack/blob/main/ER.png))
Реляционная модель
![Реляционная модель]([[https://github.com/jon/coolproject/raw/master/image/image.png](https://github.com/bag-huyag/BlackJack/blob/main/ER.png](https://github.com/bag-huyag/BlackJack/blob/main/RM.png)))

Атрибутивная модель
![Атрибутивная модель]([[[https://github.com/jon/coolproject/raw/master/image/image.png](https://github.com/bag-huyag/BlackJack/blob/main/ER.png](https://github.com/bag-huyag/BlackJack/blob/main/RM.png](https://github.com/bag-huyag/BlackJack/blob/main/AM.png))))




app - папка содержит клиентскую часть приложения (frontend).


package.json - файл, используемый в Node.js проектах для управления зависимостями, скриптами и другой информацией о проекте.

pnpm-lock.yaml - файл блокировки для менеджера пакетов pnpm, который гарантирует точное воспроизведение установленных зависимостей.

public - папка, содержащая статические файлы, такие как HTML, CSS, изображения, которые могут быть доступны в браузере напрямую.


src - папка с исходным кодом клиентской части приложения.

 App.tsx - главный компонент приложения, написанный на TypeScript с использованием JSX (расширение для JavaScript, которое позволяет описывать структуру интерфейса в виде компонентов).
			
const [token] = useLocalStorageString("token"); - Использует пользовательский хук useLocalStorageString, чтобы получить значение, сохранённое в локальном хранилище браузера (LocalStorage) под ключом "token". Этот токен используется для аутентификации пользователя. Хук возвращает первый элемент массива, который содержит значение токена, и сохраняет его в переменной token. Если токен не найден в локальном хранилище, значение token будет undefined или null. Если токен существует, это предполагает, что пользователь уже аутентифицирован. В этом случае код перенаправляет пользователя на страницу /dashboard путём изменения URL в адресной строке браузера.



 Pages - папка содержит различные страницы или маршруты приложения.

Dashboard.tsx - Используется в качестве панели управления пользовательским интерфейсом, предоставляя функционал для входа в игру, навигации, изменения настроек и выхода из системы.
Импорты и Определения: Импортируются необходимые зависимости, включая React, функцию декодирования JWT-токенов и стили.
Стейт и Функции: Используется состояние useState для управления отображением настроек (isSettingsOpen).
Функции showSettings и closeSettings для открытия и закрытия панели настроек.
Функция logout для выхода пользователя из системы, удаляя токен из локального хранилища и перенаправляя на главную страницу.
Использование useEffect: useEffect используется для создания "хака", который позволяет закрыть всплывающее окно настроек, если кликнуть вне его области.
Функция для Присоединения к Игре: Функция joinGame обрабатывает присоединение к игре по коду, введенному пользователем.
Рендеринг Компонента: Отображается имя пользователя, извлеченное из декодированного JWT-токена.
Game.tsx - Компонент React для игры, который используется в веб-приложении. 
Импорты и Определения интерфейсов.
Компонент Game: Используется localStorage для получения токена пользователя, который затем декодируется для получения данных пользователя.
 Используется useParams для получения параметра code из URL, который представляет код игры.
 В useEffect выполняется асинхронная функция getAndJoinGame для получения данных игры и присоединения к ней.
 Проверяется, не заполнена ли игра (не более 4 игроков) и не идёт ли она уже (state === "RUNNING").
 Если пользователь не является частью игры, он присоединяется к ней.
 В случае ошибки загрузки данных игры или присоединения к ней, отображается сообщение об ошибке, и пользователь перенаправляется на страницу /dashboard.
Функции вспомогательные: Определены функции rand для генерации случайных значений из массива.
Рендеринг Компонента: Отображается компонент SquareTable, которому передаётся gameCode.

Games.tsx - Используется для отображения списка игр и создания новых игр в приложении. 
Импорты и Определения интерфейса.
Компонент Games: 
Извлекается токен из локального хранилища.
Используется состояние useState для управления списком игр (games).
С помощью useEffect осуществляется запрос к серверу для получения списка игр. Загруженные данные сохраняются в состоянии games.
Функции для Управления Игрой:
openCreateGamePopup и closeCreateGamePopup для открытия и закрытия всплывающего окна создания игры.
incrementTime и decrementTime для управления временем хода в создаваемой игре.
createGame отправляет данные о новой игре на сервер. При успешном создании игры, добавляет её в список и перенаправляет пользователя на страницу новой игры.
Рендеринг Компонента.


Login.tsx - Код, который вы предоставили, представляет собой компонент входа в систему (Login) для React-приложения. 
Импорты
Определение интерфейса LoginForm
Компонент Login: С помощью хука useLocalStorageString извлекается токен из локального хранилища. 
Если токен уже существует (пользователь вошёл в систему), происходит перенаправление на страницу /dashboard. 
Создаётся состояние formData для хранения данных формы входа. 
Функция handleInputChange обрабатывает изменения в полях ввода формы, обновляя formData. Функция handleSubmit обрабатывает отправку формы. При отправке формы данные передаются на сервер через API. В случае успешного входа (статус 200) пользователь получает токен и перенаправляется на /dashboard.




Signup.tsx - 
Импорты
Компонент SignupForm - Определяется TypeScript интерфейс SignupForm, описывающий структуру данных формы регистрации: имя пользователя, электронная почта, пароль и подтверждение пароля.
Компонент Signup: Устанавливается заголовок документа, Используется пользовательский хук useLocalStorageString для работы с токеном аутентификации. 
Если токен уже существует, пользователь перенаправляется на страницу /dashboard. 
Создаётся состояние formData для хранения данных формы регистрации. handleInputChange обрабатывает изменения в полях ввода формы, обновляя formData. 
handleSubmit обрабатывает отправку формы. Проверяет, совпадают ли пароли, и если да, отправляет запрос на регистрацию пользователя через API. В случае успешной регистрации пользователь получает токен и перенаправляется на /dashboard.
ErrorPage.tsx - отрисовка компонента при ошибках
PrivateRoute.tsx - Проверка Аутентификации: Компонент проверяет, аутентифицирован ли пользователь путём проверки наличия токена аутентификации.
Условный Рендеринг:
Если пользователь аутентифицирован, компонент PrivateRoute отображает запрашиваемый компонент или страницу.
Если пользователь не аутентифицирован, PrivateRoute может перенаправить его на страницу входа или показать сообщение об ошибке.



components - папка, которая содержит переиспользуемые компоненты пользовательского интерфейса.

config.ts - файл конфигурации на TypeScript содержит глобальные настройки приложения.

hooks - Папка содержит пользовательские хуки React, предназначенные для управления состоянием и логикой компонентов.
useLocalStorage.ts - Представляет собой два пользовательских хука React для работы с локальным хранилищем (LocalStorage) браузера.Оба эти хука полезны для сохранения и извлечения данных в LocalStorage, что позволяет сохранять состояние между разными сессиями браузера.

useLocalStorageObject{}
Этот хук предназначен для работы с объектами в LocalStorage.

Работа хука:
При первом рендеринге хук пытается получить объект из LocalStorage. Если объект найден, он десериализуется из JSON-строки; если нет — используется initialValue.
При изменении value хук автоматически сериализует его в JSON и сохраняет в LocalStorage.


useLocalStorageString{}
Этот хук предназначен для работы со строковыми значениями в LocalStorage.

Работа хука:
При первом рендеринге компонента хук пытается получить значение из LocalStorage по ключу key. Если значение найдено, оно используется; если нет — используется initialValue.
Хук следит за изменениями value и автоматически сохраняет его в LocalStorage каждый раз, когда значение обновляется.




index.tsx - точка входа в приложение, где происходит рендеринг корневого компонента React.
Импорт необходимых модулей: Код импортирует React, функции для создания и работы с корнем React DOM, а также компоненты для роутинга в React.
Импорт страниц и компонентов: Импортируются различные страницы и компоненты приложения, такие как ErrorPage, Login, Signup, Dashboard, PrivateRoute, Games, Game и главный компонент App.
Настройка роутера: Создается роутер с использованием createBrowserRouter, который определяет маршруты для приложения. Каждый маршрут ассоциирован с определенным компонентом:
Корневой путь ("/") связан с главным компонентом App.
Пути "/login", "/signup", "/error" связаны со страницами входа, регистрации и ошибки соответственно.
Путь "/dashboard" использует PrivateRoute для защиты доступа, связывая его с компонентом Dashboard.
Инициализация и рендеринг приложения: Используется функция createRoot из React DOM для создания корня приложения и его рендеринга, используя RouterProvider для обеспечения роутинга на основе созданного роутера.


tsconfig.json - файл конфигурации для TypeScript, языка, который добавляет статическую типизацию в JavaScript.





ecosystem.config.js - файл конфигурации для PM2, который является менеджером процессов для Node.js приложений. Этот файл обычно содержит информацию о том, как запустить и управлять вашим Node.js приложением.





server - папка содержит серверную часть приложения (backend).

package.json - файл для управления зависимостями серверной части проекта.
pnpm-lock.yaml - файл блокировки для pnpm, указывающий на конкретные версии зависимостей, используемых на сервере.

sql - папка, которая содержит SQL процедуры и файлы для базы данных.
 all.sql  - Хранит таблицы users, games, cards, players, gamePlayerCards. 
 cards.sql - Содержит SQL-процедуры, которые управляют данными карт в базе данных для игры.
insertUniqueCards: Создает процедуру для вставки 52 уникальных игральных карт в таблицу cards.	
getCards: Создает процедуру для извлечения всех 52 карт из таблицы cards.
getACard: Создает процедуру для получения одной конкретной карты по ее идентификатору (cardId).
 drops.sql - Получение списка всех хранимых процедур в базе данных и удаление основных таблиц игры.
 gamePlayerCards.sql - Содержит процедуры, которые управляют связью между игроками, играми и картами.
getCardsByPlayerId: Выбирает все записи из таблицы gamePlayerCards, где playerId соответствует предоставленному p_playerId.
getCardsByPlayerIdAndGameCode: Выбирает карты из gamePlayerCards и присоединяет информацию о картах из таблицы cards по cardId. Предоставляет дополнительные сведения о карте, такие как name, value и suit.
createGamePlayerCard: Создает новую процедуру для добавления карты игроку в игре, используя cardId, playerId и gameCode. Проверяет существование карты, игрока и игры в соответствующих таблицах. Вычисляет числовое значение карты и обновляет счет игрока. Вычисляет числовое значение карты и обновляет счет игрока.
 games_old.sql - Содержит набор SQL-процедур для управления играми, игроками и картами.
getUserGames: Получает список всех игр, в которых участвует пользователь с указанным userId. Проверяет наличие пользователя и его участие в играх. Возвращает данные всех игр, в которых участвует пользователь.
getGameDetailsWithPlayers: Получает детали игры по gameCode, включая информацию об игроках. Возвращает информацию о игре и ее участниках с корректировкой исхода игроков на основе их счета.
getPlayerHandsAndCards: Получает руки (наборы карт) и соответствующие карты для определенного игрока в указанной игре.
createGameAndFirstPlayer: Создает новую игру и первого игрока (создателя игры). Устанавливает начальные параметры игры и добавляет первого игрока.
joinGame: Позволяет пользователю присоединиться к существующей игре. Проверяет наличие игры и место для нового игрока.
addCardToPlayerHand: Добавляет карту в руку игрока в игре. Обновляет счет игрока на основе значения добавленной карты и определяет его исход (победитель, перебор).
changePlayerTurn: Изменяет очередность хода в игре. Находит следующего игрока, который должен ходить, исключая тех, кто уже вышел из игры или достиг перебора.
 games.sql - Определены различные SQL-процедуры, относящиеся к управлению играми.
getGameByGameCode: Получает детали игры по уникальному коду игры (gameCode). Используется для извлечения информации о конкретной игре.
getAllGames: Получает детали всех доступных игр в базе данных. Используется для отображения списка всех игр.
createGame: Создает новую игру с заданными параметрами (gameCode, userId, turnTime, bet). Автоматически добавляет создателя игры в качестве игрока. Обновляет игру, устанавливая текущий идентификатор хода (currentTurnId) и идентификатор создателя (creatorId).
joinGame: Позволяет пользователю присоединиться к существующей игре. Проверяет наличие игры и пользователя, а также наличие свободных мест в игре.
restartGame: Перезапускает игру, сбрасывая счет игроков, их исходы и другие состояния, связанные с игрой.
setGameTurns: Обновляет состояние игры, устанавливая последовательность предыдущих ходов и идентификатор текущего хода.
updateGameWinner: Обновляет игру, указывая идентификатор победителя (winnerId), и изменяет исход игрока на "Победитель".
getGameAndCheckPlayers: Проверяет наличие игры и текущего игрока, а затем извлекает объединенные детали игры и игроков.
 players.sql - Cодержит набор SQL-процедур, которые связаны с управлением данными игроков
getAPlayer: Получает детали игрока по идентификатору (playerId). Используется для извлечения информации о конкретном игроке.
getPlayerByUserId: Получает детали игрока по идентификатору пользователя (userId). Позволяет связать пользователя с его игровым профилем.
getPlayerByGameId: Получает список игроков, участвующих в определенной игре, по идентификатору игры (gameId).
getPlayerByUserIdAndGameId: Получает детали игрока, участвующего в конкретной игре, по идентификатору пользователя и идентификатору игры.
createPlayer: Создает нового игрока в игре с заданными параметрами (gameId, userId, name, balance). Возвращает идентификатор нового игрока (playerId).
deletePlayer: Удаляет игрока и связанные с ним карты из игры по идентификатору игрока (playerId) и коду игры (gameCode). Обновляет количество игроков в игре.
updatePlayerReadyState: Обновляет состояние готовности игрока в игре (ready) по идентификатору игрока и коду игры.
updatePlayerStayState: Обновляет состояние "остаться" (stay) игрока в игре по идентификатору игрока и коду игры.
updatePlayerOutcome: Обновляет исход игры для игрока (outcome) по его идентификатору.
updatePlayerScore: Обновляет счет игрока (score) в игре по его идентификатору.
 users.sql - содержит набор SQL-процедур, которые связаны с управлением пользователями.
login: Процедура для входа пользователя в систему, используя его username и password.
signup: Процедура для регистрации нового пользователя с username, password и name.
updateToken: Процедура для обновления sessionToken пользователя.
getUserByToken: Процедура для получения данных пользователя по его sessionToken. Используется для идентификации и аутентификации пользователя по токену сессии.


src - папка с исходным кодом серверной части приложения.
 index.js - Является точкой входа в серверное приложение.
Загрузка переменных окружения: С помощью require('dotenv').config(), загружаются переменные окружения из файла .env. Это позволяет безопасно управлять чувствительными данными, такими как порты, ключи доступа к API и строки подключения к базе данных.
Настройка сервера Express:
Создается экземпляр Express (const app = express()).
Применяется middleware CORS (app.use(cors())) для обработки междоменных запросов.
Включается обработка JSON тел запросов (app.use(express.json())).
Маршрутизация:
Задаются маршруты для различных частей приложения, таких как пользователи (userRouter), игры (gameRouter), карты (cardRouter) и игроки (playerRouter).
Базовый маршрут:
Определяется базовый маршрут '/' с простым ответом Hello World!.
Запуск сервера:
Сервер слушает порт, указанный в переменной окружения PORT.
При запуске сервера выполняется запрос к внешнему API для добавления 52 уникальных карт в базу данных. Это делается с использованием axios.

 config.js - Предоставляет конфигурационные настройки:
gameCodeLength: Длина кода игры.
dbName: Идентификатор или имя базы данных, используемое при работе с базой данных.

 controllers  - контроллеры обеспечивают основные функциональные возможности для работы вашего игрового сервера, включая управление картами, игроками и самими играми.
cardControllers.js - Отвечает за управление картами в игре.
getCards: Получает информацию о картах из внешнего сервиса (похоже на SQL API) и форматирует полученные данные в массив объектов cards. Каждый объект card содержит id, name, value и suit карты.
gameControllers.js - 
getGames: Получает список всех игр с сервера. Данные игр извлекаются из внешнего сервиса и форматируются в массив games, где каждый элемент содержит информацию об игре, включая id, code, bet, turnTime и другие параметры. 
getAGame: Получает информацию о конкретной игре по gameCode. Дополнительно извлекает информацию об игроках и их картах, связанных с этой игрой.
createGame: Создает новую игру, генерируя случайный код игры и отправляя данные о созданной игре в базу данных через внешний сервис.
createGamePlayerCard: Создает запись о карте игрока в контексте конкретной игры.
joinGame: Позволяет пользователю присоединиться к существующей игре по ее коду.
changePlayerTurn: Управляет изменением очереди игрока в игре, обновляя информацию о текущем игроке и следующем ходе.
restartGame: Перезапускает игру для конкретного игрока, сбрасывая его состояние и карты.
playerControllers.js - 
getPlayer: Получает информацию об игроке по userId и gameCode.
Выполняет запросы к внешнему API для получения данных игры и игрока.
Формирует и отправляет объект игрока, включая его руки (карты).
getPlayerCards: Получает карты игрока по playerId и gameCode. Возвращает массив карт игрока.
deletePlayer: Удаляет игрока из игры по playerId и gameCode.
updatePlayerState: Обновляет состояние готовности игрока (ready).
updatePlayerStay: Обновляет состояние "остановиться" (stay) игрока.

userControllers.js - 
login: Авторизует пользователя, проверяя email и password. Возвращает JWT-токен при успешной аутентификации.
signup: Регистрирует нового пользователя, принимая email, password и name. Создает и возвращает JWT-токен для нового пользователя.
 middlewares 
tokenMiddleware.js -  Обеспечивает централизованную и эффективную проверку аутентификации пользователей на сервере. Оно гарантирует, что только запросы с действительными токенами будут обработаны в последующих маршрутах или контроллерах.
verifyToken: 
Проверка наличия токена:
Извлекает заголовок авторизации из запроса.
Возвращает ошибку 403 (Forbidden), если заголовок авторизации отсутствует или не содержит токена.
Извлечение токена:
Разделяет заголовок авторизации на части и извлекает токен.
Верификация токена:
Выполняет запрос к внешнему API, передавая токен для проверки его валидности.
Проверяет, связан ли токен с каким-либо пользователем в базе данных.
Обработка результата:
Возвращает ошибку 404 (Not Found), если токен недействителен или не связан с пользователем.
Если токен действителен, добавляет его в объект запроса (req.token) для использования в последующих обработчиках.
Передача управления следующему обработчику:
Вызывает next(), чтобы передать управление следующему middleware или обработчику маршрута.





